name: Publish Helm Chart

on:
  release:
    types: [published]

env:
  CHART_PATH: charts/haos-one
  ANDREYWTF_REGISTRY_HOST: registry.andrey.wtf
  REGISTRY_REPO: helm

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Package chart
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p dist
          helm lint "${CHART_PATH}"
          helm package "${CHART_PATH}" \
            --version "${VERSION}" \
            --app-version "${VERSION}" \
            --destination dist

      - name: Log in to registry
        run: |
          echo "${ANDREYWTF_REGISTRY_PASSWORD}" | helm registry login "${ANDREYWTF_REGISTRY_HOST}" \
            --username "${ANDREYWTF_REGISTRY_USERNAME}" \
            --password-stdin
        env:
          ANDREYWTF_REGISTRY_USERNAME: ${{ secrets.ANDREYWTF_REGISTRY_USERNAME }}
          ANDREYWTF_REGISTRY_PASSWORD: ${{ secrets.ANDREYWTF_REGISTRY_PASSWORD }}

      - name: Push chart
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          helm push "dist/haos-one-${VERSION}.tgz" \
            "oci://${ANDREYWTF_REGISTRY_HOST}/${REGISTRY_REPO}"
