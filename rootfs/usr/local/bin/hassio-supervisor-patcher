#!/bin/sh
set -eu

CONTAINER_NAME="hassio_supervisor"
PATCH_FILE="/patches/hassio-supervisor.patch"
PATCH_IMAGE="busybox:1.36"

log() {
  printf '%s\n' "hassio-supervisor-patcher: $*" >&2
}

apply_patch() {
  if [ ! -f "$PATCH_FILE" ]; then
    log "patch file not found at $PATCH_FILE"
    return 0
  fi

  if ! docker ps --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
    log "container $CONTAINER_NAME not found"
    return 0
  fi

  CONTAINER_ID="$(docker inspect -f '{{.Id}}' "$CONTAINER_NAME" 2>/dev/null || true)"
  if [ -z "$CONTAINER_ID" ]; then
    log "container $CONTAINER_NAME not found"
    return 0
  fi

  ROOT_DIR="$(/usr/bin/ctr -n moby containers info "$CONTAINER_ID" 2>/dev/null | jq -r '.Spec.root.path // empty')"
  if [ -z "$ROOT_DIR" ] || [ ! -d "$ROOT_DIR" ]; then
    log "container root directory not found for $CONTAINER_NAME"
    return 0
  fi

  if [ -f "$ROOT_DIR/usr/src/supervisor/supervisor/__main__.py" ] && \
    grep -q 'Patched supervisor' "$ROOT_DIR/usr/src/supervisor/supervisor/__main__.py"; then
    return 0
  fi

  docker run --rm \
    -v "$ROOT_DIR":/rootfs \
    -v "$PATCH_FILE":/patches/hassio-supervisor.patch:ro \
    "$PATCH_IMAGE" sh -c \
    'cd /rootfs && busybox patch -N -p1 -i /patches/hassio-supervisor.patch' || {
      log "patch failed; consider restarting hassos-supervisor.service"
      return 0
    }

  if ! docker restart "$CONTAINER_NAME" >/dev/null 2>&1; then
    log "failed to restart $CONTAINER_NAME"
  fi
}

if docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" >/dev/null 2>&1; then
  apply_patch || true
fi

docker events \
  --filter 'type=container' \
  --filter 'event=start' \
  --filter "container=$CONTAINER_NAME" | while read -r _; do
    apply_patch || true
  done
