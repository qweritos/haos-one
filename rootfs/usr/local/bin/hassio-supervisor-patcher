#!/bin/sh
set -eu

CONTAINER_NAME="hassio_supervisor"
PATCH_DIR="/patches/supervisor"
PATCH_IMAGE="busybox:1.36"

log() {
  printf '%s\n' "hassio-supervisor-patcher: $*" >&2
}

apply_patch() {
  if [ ! -d "$PATCH_DIR" ]; then
    log "patch directory not found at $PATCH_DIR"
    return 0
  fi

  set -- "$PATCH_DIR"/*.patch
  if [ "$1" = "$PATCH_DIR/*.patch" ]; then
    log "no patch files found in $PATCH_DIR"
    return 0
  fi

  if ! docker ps --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
    log "container $CONTAINER_NAME not found"
    return 0
  fi

  CONTAINER_ID="$(docker inspect -f '{{.Id}}' "$CONTAINER_NAME" 2>/dev/null || true)"
  if [ -z "$CONTAINER_ID" ]; then
    log "container $CONTAINER_NAME not found"
    return 0
  fi

  ROOT_DIR="$(/usr/bin/ctr -n moby containers info "$CONTAINER_ID" 2>/dev/null | jq -r '.Spec.root.path // empty')"
  if [ -z "$ROOT_DIR" ] || [ ! -d "$ROOT_DIR" ]; then
    log "container root directory not found for $CONTAINER_NAME"
    return 0
  fi

  checksum="$(printf '%s\n' "$PATCH_DIR"/*.patch | sort | while read -r patch; do sha256sum "$patch"; done | sha256sum | cut -d ' ' -f1)"
  if [ -f "$ROOT_DIR/patched" ]; then
    applied_checksum="$(cat "$ROOT_DIR/patched" 2>/dev/null || true)"
    if [ "$applied_checksum" = "$checksum" ]; then
      log "patches already applied for $CONTAINER_NAME"
      return 0
    fi
    log "patch checksum mismatch for $CONTAINER_NAME; removing container"
    if ! docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1; then
      log "failed to remove $CONTAINER_NAME"
    fi
    exit 1
  fi

  docker run --rm \
    -v "$ROOT_DIR":/rootfs \
    -v "$PATCH_DIR":/patches:ro \
    "$PATCH_IMAGE" sh -c \
    'cd /rootfs && for patch in /patches/*.patch; do busybox patch -N -p1 -i "$patch" || exit 1; done' || {
      log "patch failed; consider restarting hassos-supervisor.service"
      return 0
    }

  printf '%s\n' "$checksum" > "$ROOT_DIR/patched"
  if ! docker restart "$CONTAINER_NAME" >/dev/null 2>&1; then
    log "failed to restart $CONTAINER_NAME"
  fi
}

if docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" >/dev/null 2>&1; then
  apply_patch || true
fi

docker events \
  --filter 'type=container' \
  --filter 'event=start' \
  --filter "container=$CONTAINER_NAME" | while read -r _; do
    apply_patch || true
  done
